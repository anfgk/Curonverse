name: ğŸš€ Deploy to ìš´ì˜í™˜ê²½ í”„ë¡ íŠ¸ ì„œë²„

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set start timestamp (epoch)
        id: start_epoch
        run: echo "epoch=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Set current timestamp
        id: timestamp
        run: echo "datetime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Slack Notification - í”„ë¡ íŠ¸ ë°°í¬ ì‹œì‘
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ğŸš€ ìš´ì˜í™˜ê²½ *í”„ë¡ íŠ¸ì—”ë“œ* ë°°í¬ ì‹œì‘",
              "attachments": [
                {
                  "color": "#36C5F0",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": ":hourglass_flowing_sand: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹œì‘",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:* ${{ github.ref_name }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:* ${{ github.actor }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: SSH deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY_B64 }}
          script: |
            cd /home/ubuntu/frontend
            git pull origin main
            npm install
            npm run build
            pm2 restart next-app || pm2 start npm --name "next-app" -- start
            pm2 save

      - name: Set end timestamp (epoch)
        id: end_epoch
        run: echo "epoch=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Set end timestamp
        id: end_timestamp
        run: echo "datetime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Calculate duration
        id: duration
        run: echo "duration=$(( ${{ steps.end_epoch.outputs.epoch }} - ${{ steps.start_epoch.outputs.epoch }} ))" >> $GITHUB_OUTPUT

      - name: Slack Notification - ë°°í¬ ì„±ê³µ
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âœ… ìš´ì˜í™˜ê²½ *í”„ë¡ íŠ¸ì—”ë“œ* ë°°í¬ ì„±ê³µ",
              "attachments": [
                {
                  "color": "#2EB67D",
                  "blocks": [
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:* ${{ github.ref_name }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:* ${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "*ë°°í¬ ì‹œì‘ ì‹œê°„:* `${{ steps.timestamp.outputs.datetime }} (KST)`\n*ë°°í¬ ì¢…ë£Œ ì‹œê°„:* `${{ steps.end_timestamp.outputs.datetime }} (KST)`\n*ì†Œìš” ì‹œê°„:* `${{ steps.duration.outputs.duration }}ì´ˆ`"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notification - ë°°í¬ ì‹¤íŒ¨
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âŒ ìš´ì˜í™˜ê²½ *í”„ë¡ íŠ¸ì—”ë“œ* ë°°í¬ ì‹¤íŒ¨",
              "attachments": [
                {
                  "color": "#FF0000",
                  "blocks": [
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:* ${{ github.ref_name }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:* ${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "*ë°°í¬ ì‹œì‘ ì‹œê°„:* `${{ steps.timestamp.outputs.datetime }} (KST)`\n*ë°°í¬ ì¢…ë£Œ ì‹œê°„:* `${{ steps.end_timestamp.outputs.datetime }} (KST)`\n*ì†Œìš” ì‹œê°„:* `${{ steps.duration.outputs.duration }}ì´ˆ`"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notification - ë°°í¬ ì·¨ì†Œ
        if: cancelled()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "âš ï¸ ìš´ì˜í™˜ê²½ *í”„ë¡ íŠ¸ì—”ë“œ* ë°°í¬ ì·¨ì†Œ",
              "attachments": [
                {
                  "color": "#808080",
                  "blocks": [
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:* ${{ github.ref_name }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:* ${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "*ë°°í¬ ì‹œì‘ ì‹œê°„:* `${{ steps.timestamp.outputs.datetime }} (KST)`\n*ë°°í¬ ì¢…ë£Œ ì‹œê°„:* `${{ steps.end_timestamp.outputs.datetime }} (KST)`\n*ì†Œìš” ì‹œê°„:* `${{ steps.duration.outputs.duration }}ì´ˆ`"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
